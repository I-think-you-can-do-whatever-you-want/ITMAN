<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="positionDAO">
    <sql id="positionCondition">
        WHERE
        DEL_YN = 'N'
        AND GRO_IDX = #{searching.groIdx}
        <if test="searching.searchKeyword != null and searching.searchKeyword != ''">
            <choose>
                <when test="searching.searchCondition == 'posCode'">
                    AND POS_CODE LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                </when>
                <when test="searching.searchCondition == 'posName'">
                    AND POS_NAME LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                </when>
                <otherwise>
                    AND (POS_CODE LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                    OR POS_NAME LIKE CONCAT('%', #{searching.searchKeyword}, '%'))
                </otherwise>
            </choose>

        </if>
    </sql>
    <select id="selectPositionList" parameterType="pagination" resultType="positionVO">
        SELECT
            ROW_NUMBER() OVER(ORDER BY POS_IDX ASC) AS rowNum,
            POS_IDX AS posIdx,
            GRO_IDX AS groIdx,
            POS_CODE AS posCode,
            POS_NAME AS posName,
            DEL_YN AS delYn,
            SL_NOTE AS slNote
        FROM
            ITM_POSITION
        <include refid="positionCondition"/>

        ORDER BY rowNum DESC
        LIMIT #{startList}, #{listSize}
    </select>

    <select id="selectPositionView" resultType="positionVO" parameterType="positionVO">
        SELECT
        POS_CODE AS posCode,
        POS_IDX AS posIdx,
        POS_NAME AS posName,
        SL_NOTE AS slNote
        FROM
            ITM_POSITION
        WHERE POS_IDX = #{posIdx}
          AND DEL_YN = 'N'
    </select>

    <select id="selectPositionListCnt" parameterType="pagination" resultType="int">
        SELECT
            COUNT(*)
        FROM
            ITM_POSITION
        <include refid="positionCondition"/>
    </select>

    <select id="selectPositionsByGroup" resultType="positionVO" parameterType="string">
        SELECT POS_IDX AS posIdx,
                POS_NAME  AS posName
        FROM ITM_POSITION
        WHERE GRO_IDX = #{groIdx}
            AND DEL_YN = 'N'
        ORDER BY POS_NAME
    </select>
    <insert id="insertPosition" parameterType="positionVO">
        INSERT INTO
        ITM_POSITION
        <trim prefix="(" suffix=")" suffixOverrides=",">
            GRO_IDX,
            POS_CODE,
            POS_NAME,
            REG_DATE,
            REG_IDX,
            <if test="slNote != null and slNote.trim().length() > 0">SL_NOTE,</if>
        </trim>
            VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
        1 ,<!-- #{groIdx} 임시IDX -->
        #{posCode},
        #{posName},
        NOW(),
        77, <!-- #{regIdx} 임시IDX -->
        <if test="slNote != null and slNote.trim().length() > 0">#{slNote},</if>
        </trim>
    </insert>
    <update id="updatePosition" parameterType="positionVO">
        UPDATE
            ITM_POSITION
        SET
            POS_IDX = #{posIdx},
            POS_NAME = #{posName},
            POS_CODE = #{posCode},
            MOD_DATE = NOW()
        WHERE POS_IDX = #{posIdx}
    </update>

    <update id="deletePosition" parameterType="positionVO">
        UPDATE
            ITM_POSITION
        SET
            SL_NOTE = #{slNote},
            DEL_YN = 'Y',
            DEL_DATE = NOW()
        WHERE
            POS_IDX = #{posIdx}

    </update>
</mapper>

