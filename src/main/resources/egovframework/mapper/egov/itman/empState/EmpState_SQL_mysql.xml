<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="empStateDAO">
    <sql id="empStateCondition">
        <where>
            DEL_YN = 'N'
            AND GRO_IDX = #{pagination.searching.groIdx}
            <if test="pagination.searching.searchKeyword != null and pagination.searching.searchKeyword != ''">
                <choose>
                    <when test="pagination.searching.searchCondition == 'empStName'">
                        AND EMP_ST_NAME LIKE CONCAT('%', #{pagination.searching.searchKeyword} ,'%')
                    </when>
                    <when test="pagination.searching.searchCondition == 'slNote'">
                        AND SL_NOTE LIKE CONCAT('%', #{pagination.searching.searchKeyword} ,'%')
                    </when>
                    <otherwise>
                        AND (
                        EMP_ST_NAME LIKE CONCAT('%', #{pagination.searching.searchKeyword} ,'%')
                        OR SL_NOTE LIKE CONCAT('%', #{pagination.searching.searchKeyword} ,'%')
                        )
                    </otherwise>
                </choose>
            </if>
        </where>
    </sql>
    <select id="selectEmpStateList" parameterType="empStateVO" resultType="empStateVO">
        SELECT
        EMP_ST_IDX AS empStIdx,
        EMP_ST_CODE AS empStCode,
        EMP_ST_NAME AS empStName,
        (
        SELECT COUNT(*)
        FROM ITM_EMPLOYE e
        WHERE e.EMP_ST_IDX = s.EMP_ST_IDX
        AND e.DEL_YN = 'N'
        AND e.GRO_IDX = s.GRO_IDX
        ) AS empStCnt,
        SL_NOTE AS slNote
        FROM
        ITM_EMP_STATE s
        <include refid="empStateCondition"/>
        LIMIT #{pagination.startList}, #{pagination.listSize}
    </select>
    <select id="selectEmpStateListCnt" parameterType="empStateVO" resultType="int">
        SELECT COUNT(*)
        FROM
        ITM_EMP_STATE s
        <include refid="empStateCondition"/>

    </select>
    <select id="selectEmpStateView" parameterType="empStateVO" resultType="empStateVO">
        SELECT
            EMP_ST_IDX AS empStIdx,
            EMP_ST_CODE AS empStCode,
            EMP_ST_NAME AS empStName
        FROM
            ITM_EMP_STATE
        WHERE
            EMP_ST_IDX = #{empStIdx}
    </select>

    <select id="selectEmpStatesByGroup" resultType="empStateVO" parameterType="string">
        SELECT EMP_ST_IDX AS empStIdx,
               EMP_ST_NAME  AS empStName
        FROM ITM_EMP_STATE
        WHERE GRO_IDX = #{groIdx}
          AND DEL_YN = 'N'
        ORDER BY EMP_ST_NAME
    </select>

    <insert id="insertEmployeeState" parameterType="empStateVO">
        INSERT INTO
            ITM_EMP_STATE
        <trim prefix="(" suffix=")" suffixOverrides=",">
            GRO_IDX,
            EMP_ST_CODE,
            EMP_ST_NAME,
            EMP_ST_YN,
            REG_DATE,
            REG_IDX,
            <if test="slNote != null and slNote != ''">SL_NOTE,</if>
        </trim>
            VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
            #{groIdx} ,
            #{empStCode},
            #{empStName},
            'Y',
            NOW(),
            #{regIdx},
            <if test="slNote != null and slNote != ''">#{slNote},</if>
        </trim>
    </insert>

    <update id="updateEmployeeState" parameterType="empStateVO">
        UPDATE
        ITM_EMP_STATE
        SET
            EMP_ST_NAME = #{empStName},
            EMP_ST_CODE = #{empStCode},
            MOD_DATE = NOW(),
            MOD_IDX = #{modIdx}
        WHERE
            EMP_ST_IDX = #{empStIdx}
    </update>
    <update id="deleteEmployeeState" parameterType="empStateVO">
        UPDATE
            ITM_EMP_STATE
        SET
            DEL_YN = 'Y',
            EMP_ST_YN = 'N',
            DEL_DATE = NOW(),
            DEL_IDX = #{delIdx},
            SL_NOTE = #{slNote}
        WHERE
            EMP_ST_IDX = #{empStIdx}
    </update>
    <select id="checkDuplicate" parameterType="empStateVO" resultType="int">
        SELECT
            COUNT(*)
        FROM
            ITM_EMP_STATE
        WHERE
            DEL_YN = 'N'
        AND GRO_IDX = #{groIdx}
        AND EMP_ST_CODE = #{empStCode}
        <if test="empStIdx != null and empStIdx != ''">
            AND EMP_ST_IDX != #{empStIdx}
        </if>
    </select>
</mapper>
