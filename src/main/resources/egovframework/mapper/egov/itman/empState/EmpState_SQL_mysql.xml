<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="empStateDAO">
    <sql id="empStateCondition">
        <where>
            DEL_YN = 'N'
            AND GRO_IDX = #{searching.groIdx}
            <if test="searching.searchKeyword != null and searching.searchKeyword.trim().length() > 0">
                <choose>
                    <when test="searching.searchCondition == 'empStName'">
                        AND EMP_ST_NAME LIKE CONCAT('%', #{searching.searchKeyword} ,'%')
                    </when>
                    <when test="searching.searchCondition == 'slNote'">
                        AND SL_NOTE LIKE CONCAT('%', #{searching.searchKeyword} ,'%')
                    </when>
                    <otherwise>
                        AND (
                        EMP_ST_NAME LIKE CONCAT('%', #{searching.searchKeyword} ,'%')
                        OR SL_NOTE LIKE CONCAT('%', #{searching.searchKeyword} ,'%')
                        )
                    </otherwise>
                </choose>
            </if>
        </where>
    </sql>
    <select id="selectEmpStateList" parameterType="pagination" resultType="empStateVO">
        SELECT
            EMP_ST_IDX AS empStIdx,
            EMP_ST_CODE AS empStCode,
            EMP_ST_NAME AS empStName,
            (
                SELECT COUNT(*)
                FROM ITM_EMPLOYE e
                WHERE e.EMP_ST_IDX = s.EMP_ST_IDX
                AND e.DEL_YN = 'N'
                AND e.GRO_IDX = s.GRO_IDX
                ) AS empStCnt,
            SL_NOTE AS slNote
        FROM
            ITM_EMP_STATE s
        <include refid="empStateCondition"/>
        LIMIT #{startList}, #{listSize}
    </select>
    <select id="selectEmpStateListCnt" parameterType="pagination" resultType="int">
        SELECT COUNT(*)
        FROM
            ITM_EMP_STATE s
        <include refid="empStateCondition"/>

    </select>
    <select id="selectEmpStateView" parameterType="empStateVO" resultType="empStateVO">
        SELECT
            EMP_ST_IDX AS empStIdx,
            EMP_ST_CODE AS empStCode,
            EMP_ST_NAME AS empStName
        FROM
            ITM_EMP_STATE
        WHERE
            EMP_ST_IDX = #{empStIdx}
    </select>

    <select id="selectEmpStatesByGroup" resultType="empStateVO" parameterType="string">
        SELECT EMP_ST_IDX AS empStIdx,
               EMP_ST_NAME  AS empStName
        FROM ITM_EMP_STATE
        WHERE GRO_IDX = #{groIdx}
          AND DEL_YN = 'N'
       <!--   AND EMP_ST_YN IN ('사', 'Y') --> <!--EMP_ST_YN은 직원의 상태와 무관하게 장비 사용여부이므로 여기서는 조건 불필요 -->
        ORDER BY EMP_ST_NAME
    </select>

    <insert id="insertEmployeeState" parameterType="empStateVO">
        INSERT INTO
            ITM_EMP_STATE
        <trim prefix="(" suffix=")" suffixOverrides=",">
            GRO_IDX,
            EMP_ST_CODE,
            EMP_ST_NAME,
            EMP_ST_YN,
            REG_DATE,
            REG_IDX,
            <if test="slNote != null and slNote.trim().length() > 0">SL_NOTE,</if>
        </trim>
            VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
            1 , <!-- #{groIdx} 임시IDX -->
            #{empStCode},
            #{empStName},
            'Y',
            NOW(),
            77, <!-- #{regIdx} 임시 IDX-->
            <if test="slNote != null and slNote.trim().length() > 0">#{slNote},</if>
        </trim>
    </insert>

    <update id="updateEmployeeState" parameterType="empStateVO">
        UPDATE
        ITM_EMP_STATE
        SET
            EMP_ST_NAME = #{empStName},
            EMP_ST_CODE = #{empStCode},
            MOD_DATE = NOW(),
            MOD_IDX = 77
        WHERE
            EMP_ST_IDX = #{empStIdx}
    </update>
    <update id="deleteEmployeeState" parameterType="empStateVO">
        UPDATE
            ITM_EMP_STATE
        SET
            DEL_YN = 'Y',
            EMP_ST_YN = 'N',
            DEL_DATE = NOW(),
            DEL_IDX = 77,
            SL_NOTE = #{slNote}
        WHERE
            EMP_ST_IDX = #{empStIdx}
    </update>
</mapper>
