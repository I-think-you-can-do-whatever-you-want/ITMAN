<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="stateDAO">
    <sql id="assetStateCondition">
        <where>
            s.DEL_YN = 'N'
            AND s.GRO_IDX = #{searching.groIdx}
            <if test="searching.searchKeyword != null and searching.searchKeyword.trim().length() > 0">
                <choose>
                    <when test="searching.searchCondition == 'staCode'">
                        AND s.STA_CODE LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                    </when>
                    <when test="searching.searchCondition == 'staName'">
                        AND s.STA_NAME LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                    </when>
                    <when test="searching.searchCondition == 'staNote'">
                        AND s.STA_NOTE LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                    </when>
                    <otherwise>
                        AND (
                        s.STA_CODE LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                        OR s.STA_NAME LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                        OR s.STA_NOTE LIKE CONCAT('%', #{searching.searchKeyword}, '%')
                        )
                    </otherwise>
                </choose>
            </if>
        </where>
    </sql>
    <select id="selectAssetStateList" parameterType="pagination" resultType="stateVO">
        SELECT
            STA_IDX AS staIdx,
            STA_CODE AS staCode,
            STA_NAME AS staName,
            (
            SELECT COUNT(*)
            FROM ITM_ASSET a
            WHERE a.STA_IDX = s.STA_IDX
            AND a.DEL_YN = 'N'
            ) AS staCnt,
            STA_NOTE AS staNote
        FROM ITM_STATE s
        <include refid="assetStateCondition"/>
        LIMIT #{startList} , #{listSize}
    </select>

    <select id="selectAssetStateListCnt" parameterType="pagination" resultType="int">
        SELECT
        COUNT(*)
        FROM ITM_STATE s
        <include refid="assetStateCondition"/>
    </select>

    <select id="selectAssetStateView" parameterType="stateVO" resultType="stateVO">
        SELECT
            STA_IDX AS staIdx,
            STA_NAME AS staName,
            STA_CODE AS staCode,
            STA_NOTE AS staNote
        FROM
            ITM_STATE
        WHERE
            STA_IDX = #{staIdx}
    </select>

    <select id="selectDashBoardAssetStateList" parameterType="string" resultType="stateVO">
        SELECT
            s.STA_NAME AS staName,
            (
            SELECT COUNT(*)
            FROM ITM_ASSET a
            WHERE a.STA_IDX = s.STA_IDX
            AND a.DEL_YN = 'N'
            ) AS staCnt
        FROM
            ITM_STATE s
        WHERE s.DEL_YN = 'N'
          AND s.GRO_IDX = #{groIdx}
    </select>

    <select id="selectStatesByGroup" parameterType="string" resultType="stateVO">
        SELECT
            STA_IDX AS staIdx,
            STA_NAME AS staName
        FROM ITM_STATE
        WHERE GRO_IDX = #{groIdx}
        AND DEL_YN = 'N'
        ORDER BY STA_NAME
    </select>

    <insert id="insertAssetState" parameterType="stateVO">
        INSERT INTO
        ITM_STATE
        <trim prefix="(" suffix=")" suffixOverrides=",">
            GRO_IDX,
            STA_CODE,
            STA_NAME,
            STA_YN,
            <if test="staNote != null and staNote.trim().length() > 0">STA_NOTE,</if>
            REG_DATE,
            REG_IDX,
        </trim>
            VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
                #{groIdx},
                #{staCode},
                #{staName},
                'Y',
            <if test="staNote != null and staNote.trim().length() > 0">#{staNote},</if>
                NOW(),
                #{regIdx},
            </trim>
    </insert>

    <update id="updateAssetState" parameterType="stateVO">
        UPDATE
        ITM_STATE
        SET
            STA_NAME = #{staName},
            STA_CODE = #{staCode},
            STA_NOTE = #{staNote},
            MOD_DATE = NOW(),
            MOD_IDX = #{modIdx}
        WHERE
            STA_IDX = #{staIdx}
    </update>

    <update id="deleteAssetState" parameterType="stateVO">
        UPDATE
            ITM_STATE
        SET
            DEL_YN = 'Y',
            STA_YN = 'N',
            DEL_DATE = NOW(),
            DEL_IDX = #{delIdx}
        WHERE
            STA_IDX = #{staIdx}
    </update>
</mapper>