<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="assLogDAO">
    <insert id="insertAssLog" parameterType="assLogVO">
    INSERT INTO ITM_ASS_LOG
        <trim prefix="(" suffix=")" suffixOverrides=",">
        <if test="assNameLog != null and assNameLog != ''">ASS_NAME_LOG, </if>
            ASS_IDX,
            AL_TYPE,
            <if test="alCat != null and alCat != ''">AL_CAT, </if>
            <if test="alCont != null and alCont != ''">AL_CONT, </if>
            <if test="alNote != null and alNote != ''">AL_NOTE,</if>
            REG_DATE,
            REG_IDX,
            REG_IP
        </trim>
    VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">

        <if test="assNameLog != null and assNameLog != ''">#{assNameLog}, </if>
            #{assIdx},
            #{alType},
            <if test="alCat != null and alCat != ''">#{alCat}, </if>
            <if test="alCont != null and alCont != ''">#{alCont}, </if>
            <if test="alNote != null and alNote != ''">#{alNote}, </if>
            NOW(),
            #{regIdx},
            #{regIp}
        </trim>
    </insert>

    <select id="selectAssLogList" parameterType="string" resultType="assLogVO">
        SELECT
            L.AL_TYPE AS alType,
            L.AL_CAT AS alCat,
            L.AL_CONT AS alCont,
            L.AL_NOTE AS alNote,
            L.REG_DATE AS regDate,
            M.MEM_NAME AS memName
        FROM ITM_ASS_LOG L
        LEFT JOIN ITM_MEMBER M ON M.MEM_IDX = L.REG_IDX
        WHERE
            L.ASS_IDX = #{assIdx}
        ORDER BY L.AL_IDX DESC
    </select>

    <select id="selectDashBoardAssLogList" parameterType="string" resultType="assLogVO">
        SELECT
        (SELECT m.MEM_NAME
        FROM ITM_MEMBER m
        WHERE l.REG_IDX = m.MEM_IDX ) AS memName,
        l.REG_DATE as regDate,
        a.ASS_ULID AS assUlid,
        a.ASS_NAME AS assName,
        l.AL_TYPE AS alType,
        l.AL_CAT AS alCat,
        l.AL_CONT AS alCont,
        l.AL_NOTE AS alNote
        FROM
        ITM_ASS_LOG l
        LEFT JOIN ITM_ASSET a ON a.ASS_IDX = l.ASS_IDX
        WHERE
            a.GRO_IDX = ${groIdx}
        ORDER BY l.AL_IDX DESC
        LIMIT 0, 10
    </select>

    <sql id="assLogCondition">
        <where>
            a.GRO_IDX = ${pagination.searching.groIdx}
            <if test="pagination.searching.searchKeyword != null and pagination.searching.searchKeyword != ''">
                <choose>
                    <when test="pagination.searching.searchCondition == 'assUlid'">
                        AND a.ASS_ULID LIKE CONCAT('%', #{pagination.searching.searchKeyword}, '%')
                    </when>
                    <when test="pagination.searching.searchCondition == 'assName'">
                        AND a.ASS_NAME LIKE CONCAT('%', #{pagination.searching.searchKeyword}, '%')
                    </when>
                    <when test="pagination.searching.searchCondition == 'alCont'">
                        AND l.AL_CONT LIKE CONCAT('%', #{pagination.searching.searchKeyword}, '%')
                    </when>
                    <when test="pagination.searching.searchCondition == 'alNote'">
                        AND l.AL_NOTE LIKE CONCAT('%', #{pagination.searching.searchKeyword}, '%')
                    </when>
                    <otherwise>
                        AND (
                        a.ASS_ULID LIKE CONCAT('%', #{pagination.searching.searchKeyword}, '%')
                        OR a.ASS_NAME LIKE CONCAT('%', #{pagination.searching.searchKeyword}, '%')
                        OR l.AL_CONT LIKE CONCAT('%', #{pagination.searching.searchKeyword}, '%')
                        OR l.AL_NOTE LIKE CONCAT('%', #{pagination.searching.searchKeyword}, '%')
                        )
                    </otherwise>
                </choose>
            </if>
        </where>
    </sql>
    <select id="selectAllAssLogList" parameterType="assLogVO" resultType="assLogVO">
        SELECT
        (SELECT m.MEM_NAME
        FROM ITM_MEMBER m
        WHERE l.REG_IDX = m.MEM_IDX ) AS memName,
        l.REG_DATE as regDate,
        a.ASS_ULID AS assUlid,
        a.ASS_NAME AS assName,
        l.AL_TYPE AS alType,
        l.AL_CAT AS alCat,
        l.AL_CONT AS alCont,
        l.AL_NOTE AS alNote
        FROM
        ITM_ASS_LOG l
        LEFT JOIN ITM_ASSET a ON a.ASS_IDX = l.ASS_IDX
        <include refid="assLogCondition" />
        <choose>
            <when test="pagination.searching.orderBy != null and pagination.searching.orderBy == 'asc'">ORDER BY AL_IDX ASC </when>
            <otherwise>ORDER BY AL_IDX DESC</otherwise>
        </choose>
        LIMIT #{pagination.startList}, #{pagination.listSize}
    </select>
    <select id="selectAssLogListCnt" parameterType="assLogVO" resultType="int">
        SELECT
        COUNT(*)
        FROM
        ITM_ASS_LOG l
        LEFT JOIN ITM_ASSET a ON a.ASS_IDX = l.ASS_IDX
        <include refid="assLogCondition" />
    </select>
</mapper>