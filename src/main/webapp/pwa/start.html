<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IT MAN</title>
  <meta name="theme-color" content="#0b5fff" />
  <link rel="icon" href="/pwa/icons/icon-192.png" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; padding: 24px; }
  </style>
</head>
<body>
<h1>IT MAN 시작 중…</h1>
<p>앱을 여는 중입니다. 연결 상태에 따라 1~2초 걸릴 수 있어요.</p>

<script>
  // 1) SW 등록/장악 → 2) manifest 링크 동적 추가 → 3) 앱으로 이동
  (async function () {
    const gotoApp = () => location.replace('/index.do');

    function attachManifestOnce() {
      if (document.querySelector('link[rel="manifest"]')) return;
      const m = document.createElement('link');
      m.rel = 'manifest';
      // SW가 장악한 뒤 로드 → manifest 요청을 SW가 직접 JSON으로 응답(ngrok 경고 차단)
      m.href = '/pwa/manifest.webmanifest';
      document.head.appendChild(m);
    }

    if (!('serviceWorker' in navigator)) {
      attachManifestOnce();
      setTimeout(gotoApp, 300);
      return;
    }

    try {
      // 루트 스코프로 한 번만 등록
      let reg = await navigator.serviceWorker.getRegistration('/');
      if (!reg) {
        reg = await navigator.serviceWorker.register('/service-worker.js', { scope: '/' });
      }

      // 이미 컨트롤 중이면 바로
      if (navigator.serviceWorker.controller) {
        attachManifestOnce();
        setTimeout(gotoApp, 300);
        return;
      }

      // 첫 설치: controller 확보 대기(최대 1초)
      await new Promise((resolve) => {
        let done = false;
        const t = setTimeout(() => { if (!done) { done = true; resolve(); } }, 1000);
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (!done) { done = true; clearTimeout(t); resolve(); }
        }, { once: true });
      });

      attachManifestOnce();
    } catch (e) {
      // 실패해도 UX 보장
    } finally {
      setTimeout(gotoApp, 300);
    }
  })();
</script>
</body>
</html>
